### <ins>Given Task from DSO</ins>

### Email OTP module task

### Task
1. To implement a secure email OTP module that can be used for our enterprise application. You are free to use any standard library from the language which you choose to implement the test.
2. Do document any assumptions that you make.
3. Describe how you would test your module.

### pseudo code
```
Class Email_OTP_Module {
    /* start can be called after an instance of Email OTP is constructed. Can be used to initialise variables.
     */
    function start() {
        //optional to implement
    }

    /* close can be called after an instance of Email OTP is to be remove from the application.
     */
    function close() {
        //optional to implement
    }

    /*
    @func generate_OTP_email 
    
sends a new 6 digit random OTP code to the given email address input by the users.
Only emails from the ".dso.org.sg" domain should be allowed to receive an OTP code.
You can assume a function send_email(email_address, email_body) is implemented.
Email body to the user should be in this format "You OTP Code is 123456. The code is valid for 1 minute"

    @param user_email is an email address entered by the user. 

    @returns the following status code (assume implemented as constants) - Response is also handleded with the MojoAuth (Whole response is returned).
    STATUS_EMAIL_OK: email containing OTP has been sent successfully.
    STATUS_EMAIL_FAIL: email address does not exist or sending to the email has failed.
    STATUS_EMAIL_INVALID: email address is invalid.
    */  
    function generate_OTP_email(string user_email) {
        //implement me
    }

    /*
    @func check_OTP 
reads the input stream for user input of the OTP. The OTP to match is the current OTP generated by a send
allows user 10 tries to enter the valid OTP.
check_OTP should return after 1min if the user does not give a valid OTP. 

    @param input is a generic IOstream. It implements input.readOTP() which waits and returns the 6 digit entered by the user. this function call is blocking so you might need to wrap it in a timeout.

    @returns the following status code (assume implemented as constants)
    STATUS_OTP_OK: OTP is valid and checked
    STATUS_OTP_FAIL: OTP is wrong after 10 tries
    STATUS_OTP_TIMEOUT: timeout after 1 min
    */
    function check_OTP(iostream input) {
        //implement me
    }
}
```

---

### <ins>Documentation</ins>

* Tools Used : VS Code <br/>
* Language Used : C# <br/>
* Technology/Framework Used : .NET Core 7 <br/>
* Libraries Used : MojoAuth.NET (https://www.nuget.org/packages/MojoAuth.NET) - This library allows us to generate an OTP and send to a given Email and also doing the OTP validation. This handles the OTP expiry after the first usage and also the OTP is 6 digits long. All these were handled from the library itself and we didn't want to validate these. <br/>
* Swagger Doc  : http://localhost:5000/swagger/index.html <br/>
<img width="946" alt="image" src="https://user-images.githubusercontent.com/129241707/228788910-42558644-d8b8-4100-a45b-a20edf593003.png">

<img width="943" alt="image" src="https://user-images.githubusercontent.com/129241707/228789084-a2fcb0b4-4ac1-4b15-bcc2-4a29e59bcf00.png">

<img width="937" alt="image" src="https://user-images.githubusercontent.com/129241707/228789220-43569b8f-2da1-4dd5-98f1-7ca70a9583dc.png">

<ins>Scenarios Covered</ins> 
* A 6 digits long OTP is sent to the entered Email address. 
* Only the emails which has the ```.dso.org.sg``` domain are allowed to be send the OTP. (Please note : For the recording purpose, I have commented that logic to capture the screen shots.).
<img width="921" alt="image" src="https://user-images.githubusercontent.com/129241707/228792182-ef1931c5-98e8-44b0-ad11-945704c8f304.png">
* The sending the email part is fully covered by the 3rd party library. <br/>
* And the Email body is also handled by it and due to that, the Email content is not changed as requested in the test. <br/>
* Once the OTP generation and Email sending is done, based on the received response from the 3rd party library, response is returned from the API (StateId). <br/>

<img width="936" alt="image" src="https://user-images.githubusercontent.com/129241707/228790361-6562b2ee-5c18-4d37-b19d-0b0dcf25b30f.png">
<img width="709" alt="image" src="https://user-images.githubusercontent.com/129241707/228790626-23307718-6b67-439f-ba71-8bfe75129221.png">

* Once received the both StateId and the OTP, we can use them to validate the OTP.
    * <img width="916" alt="image" src="https://user-images.githubusercontent.com/129241707/228791108-c469e1f6-0577-4552-83d2-0b5631d13e1d.png">
    
* Until 10 Re-Try attempts, the same response will be returned.
* After the 10th attempt, the error message will be shown.
    * <img width="919" alt="image" src="https://user-images.githubusercontent.com/129241707/228791634-ef91091c-3cc3-4bb6-9100-afa50afdff05.png">
    
* The 1 min validity period validation is already handled from the 3rd party library's side.

---

### <ins>Testing Methods</ins>

* Run the project and navigate to the swagger page : http://localhost:5000/swagger/index.html

### 1. Generate OTP and Send Email
* Request CURL : Provide the Email. The Email should be a `.dso.org.sg` domain email. For the recording purpose, commented it.
```
curl -X 'POST' \
  'http://localhost:5000/api/EmailOTP/GenerateOTPEmail' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "email": "pabodha.capgemini@gmail.com"
}'
```
* Response : Returns the StateId
```
Status Code 200 -
64264c6b8ee248d9d20740f4
```

 ### 1.1 Invalid Email 
 * Request CURL : Provide an invalid Email
```
curl -X 'POST' \
  'http://localhost:5000/api/EmailOTP/GenerateOTPEmail' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "email": "pabodha.capgemini"
}'
```
* Response : Error returned.
```
Error: Bad Request - 
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "traceId": "00-f983a3dac00091a8809ba071f4d806e1-88645728dcee79bd-00",
  "errors": {
    "Email": [
      "Invalid Request - Please provide valid Email address."
    ]
  }
}
```
 ### 1.2 Invalid Email Domain
 * Request CURL : Provide an invalid Email which is not in the DSO domain
```
curl -X 'POST' \
  'http://localhost:5000/api/EmailOTP/GenerateOTPEmail' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "email": "pabodha.capgemini@gmail.com"
}'
```
* Response : Error returned.
```
Error: Bad Request - 
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.1",
  "title": "One or more validation errors occurred.",
  "status": 400,
  "traceId": "00-102de92e222e7cd3f844a0060d83fafe-e3df0928ef32baab-00",
  "errors": {
    "Email": [
      "Invalid Request - Please provide valid Email address which is on the DSO domain."
    ]
  }
}
```

### 2. Validate the OTP
* Request CURL : Provide the StateId and the OTP.
```
curl -X 'POST' \
  'http://localhost:5000/api/EmailOTP/CheckOTP' \
  -H 'accept: */*' \
  -H 'Content-Type: application/json' \
  -d '{
  "stateId": "64264c6b8ee248d9d20740f4",
  "otp": "939870"
}'
```
* Response : OTP validated and returning the User data. This is allowed to re-try for another 9 attempts.
```
Status Code 200 - 
{
  "created_at": "2023-03-31T03:00:47Z",
  "updated_at": "2023-03-31T03:00:47Z",
  "issuer": "https://www.mojoauth.com",
  "user_id": "64251092841595864e939ba4",
  "identifier": "pabodha.capgemini@gmail.com"
}
```
* Response : After 10 attempts.
```
Error: Bad Request - OTP is wrong after 10 tries
```

### Apart from these, we have added couple of Unit Tests to the project to cover the high level scenarios.
<img width="960" alt="image" src="https://user-images.githubusercontent.com/129241707/229012474-98d4769e-6c29-41f9-bb6b-d0bfa9d71b28.png">

---

### Please go through the code and the added comments for better understanding. 
Please note - I had to use VS Code as I couldn't get the Visual Studio installed on my machine due to a technical issue. So the project/folder structure is not correctly formatted according to a .NET Core project. 


